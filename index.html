<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>muf | a macadmin's metadata update feed for macOS, XProtect and more</title>
  <link href="./main.css" rel="stylesheet">
  <style>
    .text-content {
      padding-right: 80px;
      /* Adjust the padding to ensure text does not overlap the image */
    }

    .os-image {
      position: absolute;
      top: -30px;
      /* Adjust the position to let the image float on top */
      right: 15px;
      height: 60px;
      /* Adjust the size of the image as needed */
      width: auto;
      border-radius: 50%;
      /* Circular image */
    }

    .highlight-cve {
      background-color: rgb(173, 29, 79);
      box-shadow: 0 0 1px 1px rgb(173, 29, 79);
      /* Set the background color to highlight cve's */
    }

    /* Any additional custom styles */
  </style>
</head>

<body class="bg-gray-900 text-gray-300 font-sans">
  <div class="container mx-auto px-6 py-12">
    <div class="flex items-center mb-6">
      <img src="images/custom_logo.png" alt="Custom Logo" class="h-20 w-20 mr-4 sm:mr-6">
      <h1 class="text-3xl font-bold text-white">muf - metadata update feed</h1>
    </div>
    <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
      <div id="tabs" class="mb-6 flex"></div>
      <!-- CVE Search field -->
      <div class="relative mb-4">
        <input type="search" id="searchInput" placeholder="Search CVEs..." class="h-10 bg-gray-800 text-white placeholder-gray-400 pl-10 pr-4 rounded-lg border-2 border-gray-700 focus:outline-none focus:border-indigo-500">
        <div class="absolute top-0 left-0 mt-2 ml-3">
          <svg class="text-gray-400 h-6 w-6" fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" stroke="currentColor">
            <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </div>
      </div>
    </div>
    <div id="last-checked" class="mb-2 text-indigo-400"></div>
    <div id="machine-readable-feed" class="text-indigo-400 mb-6"></div>
    <div class="grid md:grid-cols-2 gap-4" id="version-and-xprotect"></div>
    <hr class="border-t-2 border-gray-700 my-8">
    <div id="security-releases" class="space-y-4">
      <h2 class="text-2xl text-indigo-400 font-semibold mb-4">Security Releases</h2>
      <a href="https://support.apple.com/en-us/HT201222" class="text-indigo-300 hover:text-indigo-200 text-lg">Apple security releases</a>
      <!-- Security releases info will be dynamically inserted here -->
    </div>
  </div>

  <script>
    // Define the data for each tab
    const tabsData = [{
        id: 'sonoma-14',
        name: 'Sonoma 14',
        file: 'muf_data_sonoma_14.json'
      },
      {
        id: 'ventura-13',
        name: 'Ventura 13',
        file: 'muf_data_ventura_13.json'
      },
      {
        id: 'monterey-12',
        name: 'Monterey 12',
        file: 'muf_data_monterey_12.json'
      }
    ];

    document.addEventListener('DOMContentLoaded', () => {
      createTabs();
    });

    function createTabs() {
      const tabsContainer = document.getElementById('tabs');
      tabsData.forEach((tab, index) => {
        const tabButton = document.createElement('button');
        tabButton.textContent = tab.name;
        tabButton.dataset.file = tab.file; // Store file path in data attribute
        tabButton.className = `px-4 py-2 rounded-lg mr-2 text-white font-medium transition duration-150 ease-in-out ${index === 0 ? 'bg-indigo-600' : 'bg-gray-700 hover:bg-indigo-500'}`;
        tabButton.onclick = () => {
          setActiveTab(tabButton);
          fetchData(tab.file, filterCVEs); // Pass filterCVEs as callback
        };
        tabsContainer.appendChild(tabButton);
      });

      // Trigger click on the first tab to load its content
      tabsContainer.firstChild.click();
    }

    function setActiveTab(activeTab) {
      document.querySelectorAll('#tabs button').forEach(btn => {
        btn.classList.replace('bg-indigo-600', 'bg-gray-700');
        btn.classList.add('hover:bg-indigo-500');
      });
      activeTab.classList.replace('bg-gray-700', 'bg-indigo-600');
      // Add this line to retrigger search filtering after tab switch
      filterCVEs();
    }

    function fetchData(file, callback) {
      fetch(file)
        .then(response => response.json())
        .then(data => {
            document.getElementById('last-checked').innerHTML = `Last checked: <span class="text-indigo-300">${data.lastCheck}</span>`;
            document.getElementById('machine-readable-feed').innerHTML = `
        Machine readable feed: 
        <a href="${file}" class="text-yellow-500 hover:text-yellow-300">${file}</a>`;
          populateVersionAndXProtect(data);
          populateSecurityReleases(data.SecurityReleases);
    
          // Invoke the callback at the end of data processing
          if (callback && typeof callback === 'function') {
            callback();
          }
        })
        .catch(error => console.error('Error fetching data:', error));
    }

    function populateVersionAndXProtect(data) {
      const versionAndXProtectContainer = document.getElementById('version-and-xprotect');
      versionAndXProtectContainer.innerHTML = ''; // Clear existing content

      const osName = data.OSVersion.split(' ')[1];
      const imageName = `${osName}.png`; // Construct the image filename like "Sonoma.png"

      const daysSinceRelease = Math.floor((new Date() - new Date(data.LatestMacOS.ReleaseDate)) / (1000 * 60 * 60 * 24));

      // Dynamically construct the macOS version section with image
      if (data.LatestMacOS) {
        const osSectionHTML = `
           <div class="relative bg-gray-800 border border-gray-600 shadow overflow-hidden sm:rounded-lg p-6 flex flex-col">
               <h3 class="text-lg leading-6 font-semibold text-indigo-400">${data.OSVersion}</h3>
               <div><strong>Last released version:</strong> ${data.LatestMacOS.ProductVersion}</div>
               <div class="mt-2 max-w-xl text-sm text-gray-400">
                   <p><strong>Build:</strong> ${data.LatestMacOS.Build}</p>
                   <p><strong>Release Date:</strong> ${formatDate(data.LatestMacOS.ReleaseDate)}</p>
                   <p><strong>Days since release:</strong> ${daysSinceRelease}</p>
               </div>
               <img src="images/${imageName}" alt="${osName}" class="absolute top-6 right-6 h-14 w-auto" onerror="this.onerror=null; this.src='default.png';">
               <div class="flex-grow"></div>
           <div class="mt-8 max-w-xl text-sm text-gray-400">
               How to Manage Updates: 
               <a href="https://support.apple.com/guide/deployment/use-mdm-to-deploy-software-updates-depafd2fad80/1/web/1.0" target="_blank" rel="noopener noreferrer" class="text-yellow-500 hover:text-yellow-300">Get to know more</a>
           </div>
           </div>
           `;
        versionAndXProtectContainer.innerHTML += osSectionHTML;
      }

      // Dynamically construct the XProtect data section
      if (data.XProtectPlistConfigData && data.XProtectPayloads) {
        const xProtectSectionHTML = `
        <div class="relative bg-gray-800 border border-gray-600 shadow overflow-hidden sm:rounded-lg p-6 mt-4 md:mt-0 md:ml-4">
            <h3 class="text-lg leading-6 font-semibold text-indigo-400">XProtect data files</h3>
            <div><strong>Latest versions:</strong> ${data.XProtectPayloads["com.apple.XProtectFramework.XProtect"]} | ${data.XProtectPayloads["com.apple.XprotectFramework.PluginService"]} | ${data.XProtectPlistConfigData["com.apple.XProtect"]}</div>
            <div class="mt-2 max-w-xl text-sm text-gray-400">
              <p><strong>XProtect.app latest version:</strong> ${data.XProtectPayloads["com.apple.XProtectFramework.XProtect"]}</p>
              <p><strong>XProtect Remediator latest version:</strong> ${data.XProtectPayloads["com.apple.XprotectFramework.PluginService"]}</p>
              <p><strong>Release Date:</strong> ${data.XProtectPayloads.ReleaseDate}</p>
            </div>
            <div class="mt-4 max-w-xl text-sm text-gray-400">
              <p><strong>XProtectPlistConfigData latest version:</strong> ${data.XProtectPlistConfigData["com.apple.XProtect"]}</p>
              <p><strong>Release Date:</strong> ${data.XProtectPlistConfigData.ReleaseDate}</p>
            </div>
             <div class="mt-8 max-w-xl text-sm text-gray-400">
                 What is XProtect: 
                 <a href="https://support.apple.com/guide/security/protecting-against-malware-sec469d47bd8/web" target="_blank" rel="noopener noreferrer" class="text-yellow-500 hover:text-yellow-300">Get to know more</a>
             </div>
    
            <img src="images/SWUpdate.png" alt="SWUpdate" class="absolute top-6 right-6 h-14 w-auto" onerror="this.onerror=null; this.src='default.png';">
          </div>
          `;
        versionAndXProtectContainer.innerHTML += xProtectSectionHTML;
      }
    }

    function populateSecurityReleases(securityReleases) {
    const securityReleasesContainer = document.getElementById('security-releases');
    securityReleasesContainer.innerHTML = `<h2 class="text-2xl text-indigo-400 font-semibold mb-4">macOS update security feed</h2>`; // Re-initialize the container with the title

    securityReleases.forEach((release, index) => {
        const warningSign = release.SecurityInfo.startsWith('http') ? `<span class="text-yellow-400"> ⚠️</span>` : '';
        const securityInfoHTML = release.SecurityInfo.startsWith('http') ?
            `<a href="${createSafeLink(release.SecurityInfo)}" class="text-yellow-500 hover:text-yellow-300" target="_blank">${release.SecurityInfo}</a>` :
            release.SecurityInfo;

        let cveLinksHTML = release.CVEs.length > 0 ? release.CVEs.map(cve =>
            `<a href="https://www.cve.org/CVERecord?id=${cve}" class="text-yellow-500 hover:text-yellow-300" target="_blank">${cve}</a>`
        ).join(', ') : '<i>This update has no published CVE entries.</i>';

        const releaseHTML = `
            <div class="${index > 0 ? 'border-t-2 border-gray-500 pt-4 mt-4' : ''}">
                <p class="mt-1 max-w-2xl text-sm text-gray-500">Release Date: ${formatDate(release.ReleaseDate)}${warningSign}</p>
                <h3 class="text-lg leading-6 font-medium text-indigo-400">${release.OSVersion}</h3>
                <p>Security Info: ${securityInfoHTML}</p>
                <p>Vulnerabilities Addressed: ${release.CVEs.length}</p>
                <p>Security Advisories (CVE Identifiers): ${cveLinksHTML}</p>
                <p class="mt-1 max-w-2xl text-sm text-gray-500">Days to Prev. Release: ${release.DaysSincePreviousRelease}</p>
            </div>
        `;
        securityReleasesContainer.innerHTML += releaseHTML;
    });
    }

    // Abstracted Search Logic for CVE Search Functionality
    function filterCVEs() {
      const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
      const securityReleasesContainer = document.getElementById('security-releases');
      const releaseContainers = securityReleasesContainer.querySelectorAll('div');

      if (searchTerm.length < 2) {
        resetSearchFiltering(releaseContainers);
      } else {
        releaseContainers.forEach(container => {
          const cveLinks = Array.from(container.querySelectorAll('a')).filter(link => link.href.includes("cve.org/CVERecord?id="));
          let found = false;
          cveLinks.forEach(link => {
            if (link.textContent.toLowerCase().includes(searchTerm)) {
              found = true;
              link.classList.add('highlight-cve');
            } else {
              link.classList.remove('highlight-cve');
            }
          });
          container.style.display = found ? 'block' : 'none';
        });
      }
    }

    // Update to use abstracted search logic
    document.getElementById('searchInput').addEventListener('input', filterCVEs);

    function resetSearchFiltering(releaseContainers) {
      releaseContainers.forEach(container => {
        container.style.display = 'block';
        const highlightedLinks = container.querySelectorAll('.highlight-cve');
        highlightedLinks.forEach(link => {
          link.classList.remove('highlight-cve');
        });
      });
    }

    function createSafeLink(url) {
      // Create a temporary element
      const tempElement = document.createElement('a');
      // Set the href attribute to the sanitized URL
      tempElement.href = url;
      // Return the sanitized href attribute value
      return tempElement.href;
    }
    
    function formatDate(dateString) {
      const date = new Date(dateString);
      // Use the browser's current language setting
      const browserLocale = navigator.language;
      return date.toLocaleDateString(browserLocale, { year: 'numeric', month: 'long', day: 'numeric' });
    }
    
  </script>
</body>

</html>